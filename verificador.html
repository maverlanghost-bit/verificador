<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coordinador de Verificación</title>
    <!-- Tailwind CSS para estilos rápidos y bonitos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse para manejar CSVs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- SheetJS para manejar Excel (.xlsx, .xls) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <style>
        /* Animaciones simples */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hidden-forcibly { display: none !important; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans min-h-screen flex flex-col">

    <!-- VISTA DE LOGIN -->
    <div id="login-view" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl max-w-md w-full border border-slate-700 fade-in">
            <div class="flex justify-center mb-6">
                <div class="bg-blue-600 p-3 rounded-full">
                    <!-- Icono Database -->
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>
                </div>
            </div>
            <h1 class="text-2xl font-bold text-center mb-2">Verificador Coordinado</h1>
            <p class="text-slate-400 text-center mb-6">Ingresa tu nombre para acceder al panel.</p>
            
            <input type="text" id="username-input" placeholder="Tu nombre (ej: Manuel)" 
                class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white mb-4 focus:ring-2 focus:ring-blue-500 outline-none transition">
            
            <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition transform active:scale-95">
                Entrar al Sistema
            </button>
            <p id="error-msg" class="text-red-400 text-xs text-center mt-4 hidden-forcibly"></p>
        </div>
    </div>

    <!-- VISTA DEL DASHBOARD (Oculta por defecto) -->
    <div id="dashboard-view" class="hidden-forcibly max-w-5xl mx-auto w-full p-4 md:p-8 space-y-6 fade-in">
        
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center bg-slate-900 p-6 rounded-2xl shadow-lg border border-slate-800">
            <div class="flex items-center gap-4 mb-4 md:mb-0">
                <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white">Panel de Verificación</h1>
                    <p class="text-slate-400 text-sm">Proyecto: Limpieza de Base de Datos</p>
                </div>
            </div>
            <div class="flex items-center gap-3 bg-slate-800 px-4 py-2 rounded-full border border-slate-700">
                <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span id="display-username" class="text-sm font-medium">Hola, Usuario</span>
            </div>
        </header>

        <!-- SEMÁFORO DE ESTADO -->
        <div id="status-card" class="p-6 rounded-2xl shadow-xl transition-all border-l-8 bg-slate-900 border-slate-700">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div id="status-icon-bg" class="p-4 rounded-full bg-slate-800">
                        <!-- Icono dinámico -->
                        <svg id="icon-unlocked" class="w-8 h-8 text-emerald-400 hidden-forcibly" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>
                        <svg id="icon-locked" class="w-8 h-8 text-red-400 hidden-forcibly" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    </div>
                    <div>
                        <h2 id="status-title" class="text-2xl font-bold text-white">CARGANDO ESTADO...</h2>
                        <p id="status-desc" class="text-slate-300">Conectando con el sistema...</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-slate-400">Total Verificado</p>
                    <p class="text-3xl font-mono font-bold text-white">
                        <span id="verified-count">0</span> 
                        <span class="text-sm text-slate-500">/ <span id="total-count">0</span></span>
                    </p>
                </div>
            </div>
        </div>

        <!-- BARRA DE PROGRESO -->
        <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
            <div class="flex justify-between mb-2 text-sm font-medium">
                <span class="text-slate-400">Progreso Global</span>
                <span id="progress-percent-text" class="text-blue-400">0% Completado</span>
            </div>
            <div class="w-full bg-slate-700 rounded-full h-4 overflow-hidden">
                <div id="progress-bar" class="bg-gradient-to-r from-blue-600 to-cyan-400 h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
        </div>

        <!-- ACCIONES -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- PANEL 1: DESCARGAR (Bloquear) -->
            <div id="panel-download" class="bg-slate-900 p-6 rounded-2xl border border-blue-500/30 transition-all">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Paso 1: Obtener Lote
                </h3>
                <p class="text-slate-400 text-sm mb-6">
                    Descarga los correos pendientes y bloquea el sistema.
                </p>
                <button id="btn-download" class="w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 transition-all bg-blue-600 hover:bg-blue-500 text-white shadow-lg">
                    <span>Bloquear y Descargar CSV</span>
                </button>
            </div>

            <!-- PANEL 2: SUBIR (Liberar) -->
            <div id="panel-upload" class="bg-slate-900 p-6 rounded-2xl border border-slate-800 opacity-50 transition-all">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Paso 2: Subir Resultados
                </h3>
                <p class="text-slate-400 text-sm mb-6">
                    Sube tu archivo (Excel o CSV) verificado para liberar el sistema.
                </p>
                <input type="file" id="upload-input" accept=".csv, .xlsx, .xls" class="hidden">
                <label id="btn-upload-label" for="upload-input" class="w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 transition-all cursor-not-allowed bg-slate-700 text-slate-500">
                    <span>Subir Archivo y Liberar</span>
                </label>
            </div>
        </div>

        <!-- MENSAJE DE ESTADO / CARGA -->
        <div id="loading-msg" class="hidden-forcibly bg-slate-800 p-4 rounded-lg flex items-center gap-3 animate-pulse border border-slate-700">
            <svg class="w-5 h-5 text-blue-400 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span id="loading-text" class="text-blue-200 text-sm font-medium">Procesando...</span>
        </div>

        <!-- ZONA ADMIN -->
        <div class="mt-8 border-t border-slate-800 pt-8">
            <h4 class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-4">Administración</h4>
            <div class="flex flex-wrap gap-4">
                <input type="file" id="initial-upload-input" accept=".csv, .xlsx, .xls" class="hidden">
                <label for="initial-upload-input" class="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-sm cursor-pointer transition border border-slate-700">
                    Cargar Base Maestra (CSV o Excel)
                </label>
                
                <button id="btn-download-report" class="flex items-center gap-2 px-4 py-2 bg-emerald-900/30 hover:bg-emerald-900/50 text-emerald-400 rounded-lg text-sm transition border border-emerald-900">
                    Descargar Reporte Final
                </button>

                <button id="btn-force-unlock" class="flex items-center gap-2 px-4 py-2 bg-red-900/20 hover:bg-red-900/40 text-red-500 rounded-lg text-sm transition border border-red-900 ml-auto hidden-forcibly">
                    Forzar Desbloqueo
                </button>
            </div>
        </div>
    </div>

    <!-- LOGICA JAVASCRIPT -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, onSnapshot, writeBatch, query, where, getDocs, updateDoc, serverTimestamp, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // --- CONFIGURACIÓN DE PRODUCCIÓN ---
        const firebaseConfig = {
            apiKey: "AIzaSyD8LhEUAPs0diKJi2aRYV-Qwtcdr8hd6ao",
            authDomain: "verificador-c4a60.firebaseapp.com",
            projectId: "verificador-c4a60",
            storageBucket: "verificador-c4a60.firebasestorage.app",
            messagingSenderId: "134491483626",
            appId: "1:134491483626:web:7eeb7b71667586503ed693"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Rutas Simplificadas (Para tu Producción)
        const COLLECTION_PATH = 'emails';
        const SYSTEM_PATH = 'system_config';

        // Estado Global
        let currentUser = null;
        let username = "";
        let systemState = { isLocked: false, lockedBy: null, totalCount: 0, verifiedCount: 0 };
        let isLoading = false;

        // --- ELEMENTOS DOM ---
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const usernameInput = document.getElementById('username-input');
        const displayUsername = document.getElementById('display-username');
        const errorMsg = document.getElementById('error-msg');
        
        // Elementos de Estado
        const statusCard = document.getElementById('status-card');
        const statusTitle = document.getElementById('status-title');
        const statusDesc = document.getElementById('status-desc');
        const iconUnlocked = document.getElementById('icon-unlocked');
        const iconLocked = document.getElementById('icon-locked');
        const statusIconBg = document.getElementById('status-icon-bg');
        const verifiedCountEl = document.getElementById('verified-count');
        const totalCountEl = document.getElementById('total-count');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-percent-text');

        // Paneles
        const panelDownload = document.getElementById('panel-download');
        const btnDownload = document.getElementById('btn-download');
        const panelUpload = document.getElementById('panel-upload');
        const btnUploadLabel = document.getElementById('btn-upload-label');
        const uploadInput = document.getElementById('upload-input');
        const loadingMsg = document.getElementById('loading-msg');
        const loadingText = document.getElementById('loading-text');
        const btnForceUnlock = document.getElementById('btn-force-unlock');

        // --- HELPER: PARSEADOR INTELIGENTE (CSV o EXCEL) ---
        const parseFile = (file) => {
            return new Promise((resolve, reject) => {
                const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');

                if (isExcel) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            // Convierte a array de objetos, igual que PapaParse
                            const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                            resolve(json);
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.onerror = (err) => reject(err);
                    reader.readAsArrayBuffer(file);
                } else {
                    // Si no es excel, asumimos CSV (PapaParse)
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => resolve(results.data),
                        error: (err) => reject(err)
                    });
                }
            });
        };

        // --- FUNCIONES UI ---
        function setLoading(loading, text = "Cargando...") {
            isLoading = loading;
            if (loading) {
                loadingMsg.classList.remove('hidden-forcibly');
                loadingText.textContent = text;
                btnDownload.disabled = true;
                uploadInput.disabled = true;
            } else {
                loadingMsg.classList.add('hidden-forcibly');
                btnDownload.disabled = false;
                uploadInput.disabled = false;
            }
        }

        function updateDashboard() {
            // Actualizar contadores
            verifiedCountEl.innerText = systemState.verifiedCount.toLocaleString();
            totalCountEl.innerText = systemState.totalCount.toLocaleString();
            
            const percent = systemState.totalCount > 0 
                ? ((systemState.verifiedCount / systemState.totalCount) * 100).toFixed(1) 
                : 0;
            progressBar.style.width = `${percent}%`;
            progressText.innerText = `${percent}% Completado`;

            // Lógica de Semáforo
            const isLockedByMe = systemState.isLocked && systemState.lockedBy === username;
            const isLockedByOther = systemState.isLocked && systemState.lockedBy !== username;

            // Reset Clases
            statusCard.className = "p-6 rounded-2xl shadow-xl transition-all border-l-8 bg-slate-900";
            statusIconBg.className = "p-4 rounded-full";
            iconUnlocked.classList.add('hidden-forcibly');
            iconLocked.classList.add('hidden-forcibly');
            btnForceUnlock.classList.add('hidden-forcibly');

            // Estados
            if (isLockedByOther) {
                // ROJO
                statusCard.classList.add('border-red-500', 'bg-red-900/20');
                statusIconBg.classList.add('bg-red-500/20', 'text-red-400');
                iconLocked.classList.remove('hidden-forcibly');
                statusTitle.innerText = "SISTEMA OCUPADO";
                statusTitle.className = "text-2xl font-bold text-red-400";
                statusDesc.innerText = `Espera, ${systemState.lockedBy} está verificando emails.`;
                
                // Bloquear acciones
                panelDownload.classList.add('opacity-50', 'border-slate-800');
                panelDownload.classList.remove('border-blue-500/30');
                btnDownload.classList.add('bg-slate-700', 'text-slate-500', 'cursor-not-allowed');
                btnDownload.classList.remove('bg-blue-600', 'hover:bg-blue-500', 'shadow-lg');
                
                panelUpload.classList.add('opacity-50');
                btnUploadLabel.classList.add('bg-slate-700', 'text-slate-500', 'cursor-not-allowed');
                
                btnForceUnlock.classList.remove('hidden-forcibly'); // Mostrar solo si está bloqueado
                
            } else if (isLockedByMe) {
                // AMBAR
                statusCard.classList.add('border-amber-500', 'bg-amber-900/20');
                statusIconBg.classList.add('bg-amber-500/20', 'text-amber-400');
                iconLocked.classList.remove('hidden-forcibly');
                statusTitle.innerText = "TIENES EL CONTROL";
                statusTitle.className = "text-2xl font-bold text-amber-400";
                statusDesc.innerText = "Has bloqueado la base. Nadie más puede descargar.";

                // Habilitar Subida
                panelUpload.classList.remove('opacity-50');
                panelUpload.classList.add('border-amber-500/50', 'shadow-amber-900/20');
                btnUploadLabel.classList.remove('bg-slate-700', 'text-slate-500', 'cursor-not-allowed');
                btnUploadLabel.classList.add('bg-amber-600', 'hover:bg-amber-500', 'text-white', 'shadow-lg', 'cursor-pointer');

                // Bloquear Descarga (ya la tienes)
                panelDownload.classList.add('opacity-50');
                btnDownload.disabled = true;

            } else {
                // VERDE
                statusCard.classList.add('border-emerald-500', 'bg-emerald-900/20');
                statusIconBg.classList.add('bg-emerald-500/20', 'text-emerald-400');
                iconUnlocked.classList.remove('hidden-forcibly');
                statusTitle.innerText = "SISTEMA LIBRE";
                statusTitle.className = "text-2xl font-bold text-emerald-400";
                statusDesc.innerText = "La base de datos está disponible.";

                // Habilitar Descarga
                panelDownload.classList.remove('opacity-50', 'border-slate-800');
                panelDownload.classList.add('border-blue-500/30', 'shadow-blue-900/20');
                btnDownload.classList.remove('bg-slate-700', 'text-slate-500', 'cursor-not-allowed');
                btnDownload.classList.add('bg-blue-600', 'hover:bg-blue-500', 'text-white', 'shadow-lg');
                btnDownload.disabled = false;

                // Bloquear Subida
                panelUpload.classList.add('opacity-50');
                btnUploadLabel.classList.add('bg-slate-700', 'text-slate-500', 'cursor-not-allowed');
                btnUploadLabel.classList.remove('bg-amber-600', 'hover:bg-amber-500', 'cursor-pointer');
            }
        }

        // --- AUTH ---
        document.getElementById('login-btn').addEventListener('click', async () => {
            const val = usernameInput.value.trim();
            if(!val) return alert("Escribe un nombre");
            username = val;
            errorMsg.classList.add('hidden-forcibly');
            
            // Login Anónimo
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                loginView.classList.add('hidden-forcibly');
                dashboardView.classList.remove('hidden-forcibly');
                displayUsername.innerText = `Hola, ${username}`;
                initRealtimeListener();
            } catch (e) {
                console.error("Login Error:", e);
                // Detección específica de error de dominio (Error común en Vercel)
                if (e.code === 'auth/unauthorized-domain' || e.message.includes('unauthorized-domain')) {
                    errorMsg.innerText = "ERROR DE CONFIGURACIÓN FIREBASE:\nEl dominio de esta web no está autorizado. Ve a Firebase Console -> Authentication -> Settings -> Authorized Domains y agrega este dominio de Vercel.";
                    errorMsg.classList.remove('hidden-forcibly');
                    alert("¡ATENCIÓN! Error de dominio no autorizado.\n\nFirebase ha bloqueado la conexión porque no has autorizado este dominio de Vercel.\n\nVe a Firebase Console -> Authentication -> Settings -> Authorized Domains y agrega la URL de tu proyecto.");
                } else {
                    errorMsg.innerText = "Error: " + e.message;
                    errorMsg.classList.remove('hidden-forcibly');
                }
            }
        });

        function initRealtimeListener() {
            const stateRef = doc(db, SYSTEM_PATH, 'state');
            onSnapshot(stateRef, (snap) => {
                if(snap.exists()) {
                    systemState = snap.data();
                    updateDashboard();
                } else {
                    // Crear si no existe
                    setDoc(stateRef, {
                        isLocked: false, lockedBy: null, lockedAt: null, totalCount: 0, verifiedCount: 0
                    });
                }
            });
        }

        // --- ACCIÓN 1: BLOQUEAR Y DESCARGAR ---
        btnDownload.addEventListener('click', async () => {
            if(isLoading || systemState.isLocked) return;
            setLoading(true, "Bloqueando y buscando emails...");

            try {
                // 1. Check doble
                const stateRef = doc(db, SYSTEM_PATH, 'state');
                const snap = await getDoc(stateRef);
                if(snap.data().isLocked) throw new Error("Alguien te ganó el bloqueo hace un segundo.");

                // 2. Lock
                await updateDoc(stateRef, {
                    isLocked: true, lockedBy: username, lockedAt: serverTimestamp()
                });

                // 3. Query
                setLoading(true, "Descargando CSV...");
                const q = query(collection(db, COLLECTION_PATH), where("status", "==", "pending"));
                const querySnapshot = await getDocs(q);
                
                const emails = [];
                querySnapshot.forEach(doc => emails.push({ email: doc.data().email }));

                if(emails.length === 0) throw new Error("No hay emails pendientes.");

                // 4. CSV Download
                const csv = Papa.unparse(emails);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `LOTE_PENDIENTE_${username}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                setLoading(false); // UI se actualizará vía listener

            } catch (e) {
                console.error(e);
                alert("Error: " + e.message);
                setLoading(false);
            }
        });

        // --- ACCIÓN 2: SUBIR Y LIBERAR (SOPORTE EXCEL + CSV) ---
        uploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            setLoading(true, "Analizando Archivo...");
            
            try {
                const rows = await parseFile(file);
                
                if(!rows.length) { setLoading(false); return alert("Archivo vacío"); }

                // Detectar columna de resultado
                const keys = Object.keys(rows[0]);
                const resKey = keys.find(k => k.toLowerCase().match(/result|status|verif/));

                if(!resKey) {
                    setLoading(false); 
                    return alert("No encontré columna de 'resultado' o 'status' en el archivo.");
                }

                // Subir en Batches
                const batchSize = 450;
                let verifiedInc = 0;
                
                for(let i=0; i<rows.length; i+=batchSize) {
                    setLoading(true, `Subiendo ${i} de ${rows.length}...`);
                    const chunk = rows.slice(i, i+batchSize);
                    const batch = writeBatch(db);
                    
                    chunk.forEach(row => {
                        const email = row.email || row.Email; // Flexibilidad
                        const res = row[resKey];
                        if(email && res) {
                            // ID encodeado
                            const docId = btoa(email).replace(/\//g, '_').replace(/\+/g, '-').replace(/=/g, '');
                            const ref = doc(db, COLLECTION_PATH, docId);
                            batch.update(ref, {
                                status: 'verified',
                                result: res,
                                verifiedBy: username,
                                verifiedAt: serverTimestamp()
                            });
                            verifiedInc++;
                        }
                    });
                    await batch.commit();
                }

                // Unlock
                setLoading(true, "Finalizando...");
                await updateDoc(doc(db, SYSTEM_PATH, 'state'), {
                    isLocked: false, lockedBy: null, lockedAt: null,
                    verifiedCount: systemState.verifiedCount + verifiedInc
                });

                alert("¡Listo! Lote subido y sistema liberado.");
                uploadInput.value = "";

            } catch(err) {
                alert("Error procesando archivo: " + err.message);
            }
            setLoading(false);
        });

        // --- ADMIN: CARGA INICIAL (SOPORTE EXCEL + CSV) ---
        document.getElementById('initial-upload-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            setLoading(true, "Leyendo Base Maestra...");

            try {
                const rows = await parseFile(file);
                const batchSize = 450;
                
                // Reset State
                await setDoc(doc(db, SYSTEM_PATH, 'state'), {
                    isLocked: false, lockedBy: null, totalCount: rows.length, verifiedCount: 0
                });

                for(let i=0; i<rows.length; i+=batchSize) {
                    setLoading(true, `Insertando ${i} / ${rows.length}...`);
                    const chunk = rows.slice(i, i+batchSize);
                    const batch = writeBatch(db);
                    chunk.forEach(row => {
                        const email = row.email || row.Email || row.EMAIL;
                        if(email) {
                            const docId = btoa(email).replace(/\//g, '_').replace(/\+/g, '-').replace(/=/g, '');
                            batch.set(doc(db, COLLECTION_PATH, docId), {
                                email: email, status: 'pending', result: null
                            });
                        }
                    });
                    await batch.commit();
                }
                alert("Base cargada exitosamente.");

            } catch(err) {
                alert("Error carga inicial: " + err.message);
            }
            setLoading(false);
        });

        // --- ADMIN: DESCARGAR REPORTE ---
        document.getElementById('btn-download-report').addEventListener('click', async () => {
            setLoading(true, "Generando reporte...");
            const q = query(collection(db, COLLECTION_PATH), where("status", "==", "verified"));
            const snap = await getDocs(q);
            const data = [];
            snap.forEach(d => data.push(d.data()));

            if(data.length) {
                const csv = Papa.unparse(data);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "REPORTE_FINAL.csv";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert("Nada verificado aún.");
            }
            setLoading(false);
        });

        // --- ADMIN: FORZAR UNLOCK ---
        btnForceUnlock.addEventListener('click', async () => {
            if(confirm("¿Seguro? Úsalo solo si el usuario se desconectó.")) {
                await updateDoc(doc(db, SYSTEM_PATH, 'state'), { isLocked: false, lockedBy: null });
            }
        });

    </script>
</body>
</html>
